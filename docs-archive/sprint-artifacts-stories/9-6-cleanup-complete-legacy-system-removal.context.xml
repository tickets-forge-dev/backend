<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>9</epicId>
    <storyId>6</storyId>
    <title>Cleanup - Complete Legacy System Removal</title>
    <status>drafted</status>
    <generatedAt>2026-02-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/9-6-cleanup-complete-legacy-system-removal.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>maintainer</asA>
    <iWant>remove ALL legacy ticket generation code that will be replaced by BMAD tech-spec integration</iWant>
    <soThat>the codebase has no dead code, reduced maintenance burden, and a clean foundation for Epic 9 implementation</soThat>
    <tasks>
      Phase 1: Delete backend/src/indexing/ (19 files) and update module imports
      Phase 2: Delete GenerationOrchestrator, MastraContentGenerator, ILLMContentGenerator
      Phase 3: Delete frontend GenerationProgress, FindingsSection components
      Phase 4: Fix all orphaned references, update tests, verify TypeScript compiles
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Indexing Module Deleted - entire backend/src/indexing/ directory (19 files) deleted, module registration removed from AppModule and TicketsModule
    AC-2: GenerationOrchestrator Deleted - backend/src/tickets/application/services/GenerationOrchestrator.ts (419 lines) deleted, removed from TicketsModule
    AC-3: MastraContentGenerator Deleted - backend/src/shared/infrastructure/mastra/MastraContentGenerator.ts (259 lines) and ILLMContentGenerator.ts (68 lines) deleted
    AC-4: Frontend Generation Components Deleted - GenerationProgress.tsx (298 lines), GenerationProgress.test.tsx (313 lines), FindingsSection.tsx (198 lines) deleted
    AC-5: Module Imports Updated - app.module.ts and tickets.module.ts cleaned of all deleted imports
    AC-6: No Orphaned References - TypeScript compiles with zero errors, no dead imports
    AC-7: Validators Preserved - All 7 validators in backend/src/tickets/infrastructure/services/validators/ kept intact
    AC-8: Integration Tests Updated - validation-system.integration.spec.ts updated or removed
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epics" section="Story 9.6: Cleanup - Complete Legacy System Removal" snippet="Complete deletion inventory with verified file paths, line counts, and deletion phases." />
      <doc path="docs/architecture.md" title="Architecture" section="BMAD Tech-Spec Integration Architecture (Epic 9)" snippet="Describes what replaces deleted code: GitHubFileService, TechSpecGenerator, 4-stage wizard." />
      <doc path="docs/sprint-artifacts/8-4-bmad-migration-plan.md" title="Migration Plan" section="Migration Phases" snippet="Defines phased approach: Backend Services → Workflow → Frontend → Cleanup." />
      <doc path="docs/sprint-artifacts/8-0-bmad-integration-overview.md" title="BMAD Overview" section="What We Remove" snippet="High-level summary of Firebase indexing, IndexQueryService, MastraContentGenerator methods being replaced." />
      <doc path="CLAUDE.md" title="Project Rules" section="Architecture Rules" snippet="Clean Architecture: presentation → application → domain ← infrastructure. Domain must not depend on NestJS." />
    </docs>

    <code>
      <!-- FILES TO DELETE -->
      <file path="backend/src/indexing/" kind="module" symbol="IndexingModule" lines="all" reason="ENTIRE DIRECTORY DELETED - 19 files, replaced by GitHub API file reading" />
      <file path="backend/src/indexing/indexing.module.ts" kind="module" symbol="IndexingModule" lines="1-66" reason="NestJS module registering all indexing providers - delete entirely" />
      <file path="backend/src/indexing/application/services/index-query.service.ts" kind="service" symbol="IndexQueryService" lines="1-150" reason="Vector search queries - replaced by GitHub API" />
      <file path="backend/src/indexing/application/services/repo-indexer.service.ts" kind="service" symbol="RepoIndexerService" lines="all" reason="Repository indexing orchestration - no longer needed" />
      <file path="backend/src/indexing/application/services/file-parser.service.ts" kind="service" symbol="FileParserService" lines="all" reason="Code file parsing - replaced by direct GitHub file reading" />
      <file path="backend/src/indexing/application/services/api-spec-indexer.interface.ts" kind="interface" symbol="IApiSpecIndexer" lines="all" reason="API spec indexing interface - not needed" />
      <file path="backend/src/indexing/application/jobs/indexing.processor.ts" kind="processor" symbol="IndexingProcessor" lines="all" reason="Queue-based indexing jobs - no longer needed" />
      <file path="backend/src/indexing/domain/Index.ts" kind="entity" symbol="Index" lines="all" reason="Index domain entity - replaced by GitHub API" />
      <file path="backend/src/indexing/domain/IndexRepository.ts" kind="port" symbol="IndexRepository, INDEX_REPOSITORY" lines="all" reason="Index repository port - no longer needed" />
      <file path="backend/src/indexing/domain/FileMetadata.ts" kind="value-object" symbol="FileMetadata" lines="all" reason="File metadata VO - not needed with GitHub API" />
      <file path="backend/src/indexing/domain/ApiSpecRepository.ts" kind="port" symbol="ApiSpecRepository" lines="all" reason="API spec repository port" />
      <file path="backend/src/indexing/domain/entities/ApiSpec.ts" kind="entity" symbol="ApiSpec" lines="all" reason="API spec entity" />
      <file path="backend/src/indexing/domain/entities/ApiEndpoint.ts" kind="entity" symbol="ApiEndpoint" lines="all" reason="API endpoint entity" />
      <file path="backend/src/indexing/domain/__tests__/Index.spec.ts" kind="test" symbol="Index tests" lines="all" reason="Tests for deleted entity" />
      <file path="backend/src/indexing/infrastructure/persistence/firestore-index.repository.ts" kind="repository" symbol="FirestoreIndexRepository" lines="all" reason="Firestore persistence for indexes" />
      <file path="backend/src/indexing/infrastructure/persistence/firestore-api-spec.repository.ts" kind="repository" symbol="FirestoreApiSpecRepository" lines="all" reason="Firestore persistence for API specs" />
      <file path="backend/src/indexing/infrastructure/services/api-spec-indexer.service.ts" kind="service" symbol="ApiSpecIndexerService" lines="all" reason="API spec indexer implementation" />
      <file path="backend/src/indexing/infrastructure/services/__tests__/api-spec-indexer.service.spec.ts" kind="test" symbol="ApiSpecIndexer tests" lines="all" reason="Tests for deleted service" />
      <file path="backend/src/indexing/presentation/controllers/indexing.controller.ts" kind="controller" symbol="IndexingController" lines="all" reason="REST endpoints for indexing - no longer needed" />
      <file path="backend/src/indexing/presentation/dto/indexing.dto.ts" kind="dto" symbol="IndexingDto" lines="all" reason="DTOs for indexing endpoints" />

      <file path="backend/src/tickets/application/services/GenerationOrchestrator.ts" kind="service" symbol="GenerationOrchestrator" lines="1-419" reason="DELETE - 8-step orchestrator replaced by BMAD tech-spec workflow" />
      <file path="backend/src/tickets/application/services/GenerationOrchestrator.spec.ts" kind="test" symbol="GenerationOrchestrator tests" lines="all" reason="DELETE - Tests for deleted orchestrator" />
      <file path="backend/src/shared/infrastructure/mastra/MastraContentGenerator.ts" kind="service" symbol="MastraContentGenerator" lines="1-259" reason="DELETE - extractIntent, detectType, generateDraft, generateQuestions all replaced by TechSpecGenerator" />
      <file path="backend/src/shared/application/ports/ILLMContentGenerator.ts" kind="interface" symbol="ILLMContentGenerator, LLM_CONTENT_GENERATOR" lines="1-68" reason="DELETE - Interface for deleted implementation. CAUTION: 3 validators depend on this (see constraints)" />

      <file path="client/src/tickets/components/GenerationProgress.tsx" kind="component" symbol="GenerationProgress" lines="1-298" reason="DELETE - 8-step progress UI replaced by 4-stage wizard" />
      <file path="client/src/tickets/components/GenerationProgress.test.tsx" kind="test" symbol="GenerationProgress tests" lines="1-313" reason="DELETE - Tests for deleted component" />
      <file path="client/src/tickets/components/FindingsSection.tsx" kind="component" symbol="FindingsSection" lines="1-198" reason="DELETE - Findings display integrated into BMAD draft review" />

      <!-- FILES TO MODIFY (NOT DELETE) -->
      <file path="backend/src/app.module.ts" kind="module" symbol="AppModule" lines="7,19" reason="MODIFY - Remove IndexingModule import (line 7) and from imports array (line 19)" />
      <file path="backend/src/tickets/tickets.module.ts" kind="module" symbol="TicketsModule" lines="7,23,27,34" reason="MODIFY - Remove GenerationOrchestrator import (line 7), IndexingModule import (line 23), from imports array (line 27), from providers (line 34)" />
      <file path="backend/src/shared/shared.module.ts" kind="module" symbol="SharedModule" lines="4-5,14-17,19" reason="MODIFY - Remove MastraContentGenerator import (line 4), ILLMContentGenerator import (line 5), LLM_CONTENT_GENERATOR provider (lines 14-17), export (line 19)" />
      <file path="backend/src/tickets/application/use-cases/CreateTicketUseCase.ts" kind="use-case" symbol="CreateTicketUseCase" lines="4,23,72-76" reason="MODIFY - Remove GenerationOrchestrator import (line 4), constructor injection (line 23), orchestrate call (lines 72-76). Leave buildRepositoryContext intact." />
      <file path="client/app/(main)/tickets/create/page.tsx" kind="page" symbol="CreateTicketPage" lines="10,70+" reason="MODIFY - Remove GenerationProgress import (line 10) and usage in JSX" />
      <file path="backend/src/__tests__/integration/validation-system.integration.spec.ts" kind="test" symbol="validation integration tests" lines="18,60" reason="MODIFY - Remove LLM_CONTENT_GENERATOR import and mock provider, or delete if entirely dependent" />

      <!-- FILES TO KEEP (validators use ILLMContentGenerator) - CRITICAL DEPENDENCY -->
      <file path="backend/src/tickets/infrastructure/services/validators/FeasibilityValidator.ts" kind="validator" symbol="FeasibilityValidator" lines="16,21-22" reason="KEEP but NEEDS UPDATE - imports ILLMContentGenerator. When interface is deleted, this validator must be refactored to remove LLM dependency or use a new interface." />
      <file path="backend/src/tickets/infrastructure/services/validators/ConsistencyValidator.ts" kind="validator" symbol="ConsistencyValidator" lines="15,20-21" reason="KEEP but NEEDS UPDATE - imports ILLMContentGenerator. Same refactoring needed." />
      <file path="backend/src/tickets/infrastructure/services/validators/ClarityValidator.ts" kind="validator" symbol="ClarityValidator" lines="16,28-29" reason="KEEP but NEEDS UPDATE - imports ILLMContentGenerator. Same refactoring needed." />
    </code>

    <dependencies>
      <backend>
        <package name="@nestjs/common" note="Module system, Injectable, Inject decorators" />
        <package name="@nestjs/bull" note="Queue processing - used by indexing.processor.ts being deleted" />
        <package name="bull" note="Queue backing - may become unused after indexing deletion" />
        <package name="@apidevtools/swagger-parser" note="Used by api-spec-indexer.service.ts being deleted - may become unused" />
        <package name="ai" note="ai-sdk used by MastraContentGenerator - will be reused by TechSpecGenerator later" />
        <package name="@ai-sdk/anthropic" note="LLM provider - stays for future BMAD use" />
        <package name="firebase-admin" note="Firestore persistence - stays" />
        <package name="@octokit/rest" note="GitHub API - stays and grows in importance" />
        <package name="simple-git" note="Used by indexing - may become unused after deletion" />
      </backend>
      <client>
        <package name="firebase" note="Firestore listeners - used by GenerationProgress being deleted. Still used elsewhere." />
        <package name="lucide-react" note="Icons - used by GenerationProgress. Still used elsewhere." />
      </client>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="CLAUDE.md">Clean Architecture: presentation → application → domain ← infrastructure. Domain must not depend on NestJS, Firebase, HTTP, or external SDKs.</constraint>
    <constraint source="CLAUDE.md">Use Cases are the only entry points for business operations. When deleting GenerationOrchestrator, ensure CreateTicketUseCase remains functional (may need to stub the orchestration call).</constraint>
    <constraint source="docs/architecture.md">Feature-based modules with internal layers. Each module has its own module.ts registering providers.</constraint>
    <constraint source="docs/architecture.md">Mastra handles LLM content generation. When removing current Mastra integration, ensure the shared module still exports needed services (FirebaseService, LLMConfigService, GitHubApiService).</constraint>
    <constraint source="story">CRITICAL: 3 validators (FeasibilityValidator, ConsistencyValidator, ClarityValidator) import ILLMContentGenerator. Deleting the interface BREAKS these validators. Options: (a) Keep a minimal ILLMContentGenerator with only the methods validators use, (b) Refactor validators to remove LLM dependency, or (c) Create a new minimal interface for validators.</constraint>
    <constraint source="story">CRITICAL: CreateTicketUseCase.ts calls generationOrchestrator.orchestrate(aec) on line 72. After deleting GenerationOrchestrator, this use case must either stub the call or be temporarily modified to skip generation until the new BMAD workflow (Story 9.4) is ready.</constraint>
    <constraint source="story">Deletion order matters: Indexing → GenerationOrchestrator → MastraContentGenerator → Frontend. This avoids cascading compile errors.</constraint>
    <constraint source="story">All 7 validators in backend/src/tickets/infrastructure/services/validators/ must be preserved.</constraint>
  </constraints>

  <interfaces>
    <interface name="ILLMContentGenerator" kind="TypeScript interface" signature="extractIntent(), detectType(), generateDraft(), generateQuestions()" path="backend/src/shared/application/ports/ILLMContentGenerator.ts">
      Being deleted. But FeasibilityValidator, ConsistencyValidator, ClarityValidator inject LLM_CONTENT_GENERATOR token. Must handle this dependency.
    </interface>
    <interface name="LLM_CONTENT_GENERATOR" kind="NestJS injection token" signature="Symbol('ILLMContentGenerator')" path="backend/src/shared/application/ports/ILLMContentGenerator.ts">
      Injection token used by SharedModule provider registration and 3 validators. Registered in shared.module.ts line 15.
    </interface>
    <interface name="GenerationOrchestrator.orchestrate()" kind="method" signature="async orchestrate(aec: AEC): Promise&lt;void&gt;" path="backend/src/tickets/application/services/GenerationOrchestrator.ts">
      Called by CreateTicketUseCase.execute() line 72 as fire-and-forget. Must handle this caller when deleting.
    </interface>
    <interface name="IndexingModule exports" kind="NestJS module" signature="exports: [IndexQueryService, INDEX_REPOSITORY, ...]" path="backend/src/indexing/indexing.module.ts">
      Exported to TicketsModule (imported on line 27 of tickets.module.ts). Must remove import.
    </interface>
    <interface name="GenerationProgress component" kind="React component" signature="GenerationProgress({ aecId, workspaceId, onComplete, showContinueButton })" path="client/src/tickets/components/GenerationProgress.tsx">
      Imported by client/app/(main)/tickets/create/page.tsx line 10. Must remove import and JSX usage.
    </interface>
  </interfaces>

  <tests>
    <standards>Backend uses Jest with NestJS testing utilities. Tests follow pattern: *.spec.ts for unit tests in same directory, integration tests in backend/src/__tests__/integration/. Client uses Jest with React Testing Library. Test files follow pattern: *.test.tsx alongside components.</standards>
    <locations>
      backend/src/**/*.spec.ts
      backend/src/__tests__/integration/
      client/src/**/*.test.tsx
    </locations>
    <ideas>
      <idea ac="AC-1">After deleting indexing/, verify no import references remain: grep -r "indexing" backend/src/ --include="*.ts" should return 0 hits outside of deleted files</idea>
      <idea ac="AC-2">After deleting GenerationOrchestrator, verify CreateTicketUseCase still constructs without error (may need mock/stub)</idea>
      <idea ac="AC-3">After removing LLM_CONTENT_GENERATOR from SharedModule, verify validators that depend on it are handled</idea>
      <idea ac="AC-5">After module updates, run: cd backend && npx tsc --noEmit to verify zero TypeScript errors</idea>
      <idea ac="AC-6">Run full grep scan for all deleted symbols: GenerationOrchestrator, IndexQueryService, IndexingModule, MastraContentGenerator, GenerationProgress, FindingsSection</idea>
      <idea ac="AC-7">Verify each validator file still compiles: CompletenessValidator, TestabilityValidator, ClarityValidator, FeasibilityValidator, ConsistencyValidator, ContextAlignmentValidator, ScopeValidator</idea>
      <idea ac="AC-8">Review validation-system.integration.spec.ts - if it mocks LLM_CONTENT_GENERATOR, update mock or delete test</idea>
    </ideas>
  </tests>
</story-context>
