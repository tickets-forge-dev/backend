<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>9</storyId>
    <title>Team Settings Page</title>
    <status>drafted</status>
    <generatedAt>2026-02-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/1-9-team-settings-page.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>team owner</asA>
    <iWant>a settings page to manage my team (edit name, delete team)</iWant>
    <soThat>I can maintain my team configuration and remove teams I no longer need</soThat>
    <tasks>
      <task id="1" ac="5">Backend - Implement DeleteTeamUseCase
        <subtask>Create DeleteTeamUseCase.ts in backend/src/teams/application/use-cases/</subtask>
        <subtask>Verify user is team owner (throw ForbiddenException if not)</subtask>
        <subtask>Implement soft delete (set deletedAt timestamp in domain)</subtask>
        <subtask>Update Team domain model with delete() method</subtask>
        <subtask>Handle edge case: user's currentTeamId matches deleted team</subtask>
        <subtask>Wire use case into TeamsController.deleteTeam() (line 187-190)</subtask>
      </task>
      <task id="2" ac="5">Backend - Register DeleteTeamUseCase
        <subtask>Add to TeamsModule providers</subtask>
        <subtask>Update controller to call use case instead of throwing BadRequestException</subtask>
      </task>
      <task id="3" ac="1,2,3,7">Frontend - Create Team Settings Page Component
        <subtask>Create page at client/app/(main)/settings/team/page.tsx</subtask>
        <subtask>Load currentTeam from useTeamStore</subtask>
        <subtask>Input field for team name (controlled component)</subtask>
        <subtask>Save button calls updateTeam() from store</subtask>
        <subtask>Show success toast on save</subtask>
        <subtask>Show error toast on failure</subtask>
      </task>
      <task id="4" ac="4,8,10">Frontend - Implement Delete Functionality
        <subtask>Add Delete button (danger variant, bottom of page)</subtask>
        <subtask>Create confirmation dialog component (AlertDialog from shadcn/ui)</subtask>
        <subtask>Dialog text: "Are you sure? This will permanently delete [Team Name] and cannot be undone."</subtask>
        <subtask>On confirm: call teamStore.deleteTeam(teamId)</subtask>
        <subtask>After successful delete: redirect to / or prompt to create new team if no teams left</subtask>
        <subtask>Handle auto-switch to first available team if deleted team was current</subtask>
      </task>
      <task id="5" ac="6">Frontend - Role-Based Access Control
        <subtask>Check if currentTeam.isOwner === true</subtask>
        <subtask>If not owner: show read-only view or ForbiddenMessage component</subtask>
        <subtask>Disable delete button for non-owners (or hide entirely)</subtask>
      </task>
      <task id="6" ac="9">Build Verification
        <subtask>Run `npm run build` for both backend and frontend</subtask>
        <subtask>Verify 0 TypeScript errors</subtask>
        <subtask>Test delete flow end-to-end</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Team settings page accessible at /settings/team</criterion>
    <criterion id="2">Displays current team name in editable input field</criterion>
    <criterion id="3">Save button updates team name via backend API</criterion>
    <criterion id="4">Delete button available (owner only, with confirmation dialog)</criterion>
    <criterion id="5">DeleteTeamUseCase implemented on backend (soft delete)</criterion>
    <criterion id="6">Non-owners see read-only view or access denied</criterion>
    <criterion id="7">Success/error toast notifications on save/delete</criterion>
    <criterion id="8">Deleting current team switches to first available team (or creates prompt to create new)</criterion>
    <criterion id="9">Build passes with 0 TypeScript errors</criterion>
    <criterion id="10">Navigation updates after delete (redirects appropriately)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/IMPLEMENTATION-PLAN.md" title="Implementation Plan" section="EPIC 1: Team Foundation" snippet="Story 1.9: Team Settings Page (2d) - /settings/team. Implements team management UI with edit name and delete functionality. Owner-only access with confirmation dialog." />
      <doc path="docs/CLAUDE.md" title="Project Standards" section="Architecture Rules" snippet="Clean Architecture: presentation → application → domain ← infrastructure. Domain must not depend on NestJS, Firebase, HTTP. Use Cases are only entry points. Atomic Design for frontend: Pages are route shells with minimal logic." />
    </docs>
    <code>
      <artifact path="backend/src/teams/domain/Team.ts" kind="domain-model" symbol="Team" lines="1-176" reason="Team entity - needs delete() method added for soft delete (set deletedAt timestamp)" />
      <artifact path="backend/src/teams/application/use-cases/UpdateTeamUseCase.ts" kind="use-case" symbol="UpdateTeamUseCase" lines="1-109" reason="Pattern to follow for DeleteTeamUseCase: ownership check, domain method call, repository save" />
      <artifact path="backend/src/teams/application/use-cases/CreateTeamUseCase.ts" kind="use-case" symbol="CreateTeamUseCase" lines="1-100" reason="Use case pattern for Teams module - follow same structure for DeleteTeamUseCase" />
      <artifact path="backend/src/teams/presentation/controllers/teams.controller.ts" kind="controller" symbol="TeamsController.deleteTeam" lines="187-190" reason="DELETE endpoint exists but throws 'not yet implemented' - wire up DeleteTeamUseCase here" />
      <artifact path="backend/src/teams/infrastructure/persistence/FirestoreTeamRepository.ts" kind="repository" symbol="FirestoreTeamRepository" reason="Repository will need delete/soft-delete method for Team entity" />
      <artifact path="backend/src/teams/teams.module.ts" kind="module" symbol="TeamsModule" lines="1-60" reason="Register DeleteTeamUseCase in providers array" />
      <artifact path="client/src/teams/stores/team.store.ts" kind="state-store" symbol="useTeamStore.deleteTeam" lines="276-287" reason="Frontend deleteTeam() already implemented - calls API, removes from list, clears currentTeam if deleted" />
      <artifact path="client/src/teams/services/team.service.ts" kind="service" symbol="TeamService" reason="API client for team operations - has deleteTeam(teamId) method" />
      <artifact path="client/src/core/components/ui/button.tsx" kind="ui-component" symbol="Button" reason="shadcn/ui Button component with variant='destructive' for delete button" />
      <artifact path="client/src/core/components/ui/input.tsx" kind="ui-component" symbol="Input" reason="shadcn/ui Input component for team name field" />
      <artifact path="client/src/core/components/ui/label.tsx" kind="ui-component" symbol="Label" reason="shadcn/ui Label component for form labels" />
    </code>
    <dependencies>
      <node>
        <package name="next" version="^15.5.11" />
        <package name="react" version="^19.0.0" />
        <package name="zustand" version="^4.5.0" />
        <package name="sonner" version="^2.0.7" />
        <package name="@radix-ui/react-dialog" version="^1.1.15" />
        <package name="lucide-react" version="^0.563.0" />
        <package name="axios" version="^1.6.5" />
      </node>
      <nest>
        <package name="@nestjs/common" />
        <package name="firebase-admin" />
      </nest>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Backend: Follow Clean Architecture - DeleteTeamUseCase in application layer, Team.delete() in domain layer</constraint>
    <constraint>Backend: Use ForbiddenException for non-owner access (not BadRequestException)</constraint>
    <constraint>Backend: Soft delete only - set deletedAt timestamp, don't physically remove from Firestore</constraint>
    <constraint>Backend: Controller returns 204 No Content on successful delete</constraint>
    <constraint>Frontend: Follow Atomic Design - page.tsx at template level, use shadcn/ui molecules (AlertDialog)</constraint>
    <constraint>Frontend: Use useTeamStore hook - deleteTeam() method already implemented</constraint>
    <constraint>Frontend: Use sonner for toast notifications (not custom toast implementation)</constraint>
    <constraint>Frontend: Linear-inspired design - flat, calm, minimal, danger actions in red with clear warnings</constraint>
    <constraint>Frontend: Route is /settings/team (Next.js App Router convention)</constraint>
    <constraint>Frontend: Must check currentTeam.isOwner for role-based access control</constraint>
  </constraints>

  <interfaces>
    <interface name="Team.delete()" kind="domain-method" signature="delete(): Team" path="backend/src/teams/domain/Team.ts">
      Returns new Team instance with deletedAt timestamp set to current date
    </interface>
    <interface name="DeleteTeamCommand" kind="use-case-command" signature="{ userId: string; teamId: string }" path="backend/src/teams/application/use-cases/DeleteTeamUseCase.ts">
      Command interface for DeleteTeamUseCase.execute()
    </interface>
    <interface name="DELETE /api/teams/:id" kind="rest-endpoint" signature="DELETE /api/teams/:id → 204 No Content" path="backend/src/teams/presentation/controllers/teams.controller.ts">
      Controller endpoint that calls DeleteTeamUseCase
    </interface>
    <interface name="useTeamStore().deleteTeam" kind="state-action" signature="deleteTeam(teamId: string): Promise<void>" path="client/src/teams/stores/team.store.ts">
      Zustand store action - calls teamService.deleteTeam(), removes from list, clears currentTeam if deleted
    </interface>
    <interface name="teamService.deleteTeam" kind="api-client" signature="deleteTeam(teamId: string): Promise<void>" path="client/src/teams/services/team.service.ts">
      Frontend API client method for DELETE /api/teams/:id
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend: Jest unit tests for use cases and domain models in *.spec.ts files alongside source. Mock repositories with in-memory implementations. Pattern: describe/it blocks, expect assertions, test ownership validation, soft delete behavior.

      Frontend: Component tests in Epic 8 (not this story). Manual testing via dev server for now.
    </standards>
    <locations>
      backend/src/teams/application/use-cases/*.spec.ts
      backend/src/teams/domain/*.spec.ts
    </locations>
    <ideas>
      <test ac="5">DeleteTeamUseCase - should throw ForbiddenException if user is not owner</test>
      <test ac="5">DeleteTeamUseCase - should set deletedAt timestamp on Team entity</test>
      <test ac="5">DeleteTeamUseCase - should call repository.update with deleted team</test>
      <test ac="5">Team.delete() - should return new instance with deletedAt set</test>
      <test ac="5">Team.delete() - should preserve other fields (id, name, ownerId)</test>
      <test ac="4,8">Frontend manual: Delete button triggers confirmation dialog</test>
      <test ac="4,8">Frontend manual: Confirming delete removes team from list</test>
      <test ac="8">Frontend manual: Deleting current team switches to first available team</test>
      <test ac="6">Frontend manual: Non-owner sees read-only view (no delete button)</test>
    </ideas>
  </tests>
</story-context>
