<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>9</epicId>
    <storyId>3</storyId>
    <title>Codebase Analyzer (Pattern Analysis)</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-02-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/9-3-codebase-analyzer-pattern-analysis.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>a service that analyzes codebase patterns and conventions</iWant>
    <soThat>generated specs follow existing patterns in the code and recommendations are aligned with the project's practices</soThat>
    <tasks>
      Phase 1: Create CodebaseAnalyzer interface with 7 methods in domain layer
      Phase 2: Implement CodebaseAnalyzerImpl with detection logic for architecture, naming, testing, state management, API routing
      Phase 3: Implement comprehensive pattern detection for 6 pattern categories
      Phase 4: Create confidence scoring system (0-100 scale)
      Phase 5: Write unit tests covering all detection scenarios (100% coverage)
      Phase 6: Add JSDoc documentation with algorithm explanations
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Detects architecture pattern (feature-based, layered, monorepo, hexagonal, clean architecture, etc.)
    AC-2: Detects naming conventions (camelCase vs snake_case for functions/variables/files, PascalCase for classes/components)
    AC-3: Detects testing strategy (Jest/Vitest, test location patterns, test file naming)
    AC-4: Detects state management approach (Zustand, Redux, Context API, Vuex, MobX, etc.)
    AC-5: Detects API routing convention (Next.js App Router vs Pages Router, Express routes, tRPC, etc.)
    AC-6: Identifies project structure (root, src/, app/, pages/, lib/, utils/, hooks/, components/ etc.)
    AC-7: Returns comprehensive structured analysis object with detected patterns and confidence scores
    AC-8: Handles various project structures gracefully (single repo, monorepo, minimal projects)
    AC-9: Comprehensive unit tests (100% coverage)
    AC-10: JSDoc documentation with examples
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Architecture" section="BMAD Tech-Spec Integration Architecture (Epic 9)" snippet="CodebaseAnalyzer detects patterns to align generated specs with existing codebase conventions and architecture." />
      <doc path="docs/architecture.md" title="Architecture" section="Implementation Patterns" snippet="Feature-based modules with internal Clean Architecture layers; CodebaseAnalyzer will detect these patterns automatically." />
      <doc path="docs/epics.md" title="Epics" section="Story 9-3: Codebase Analyzer" snippet="Analyzes repository structure to detect architecture patterns, naming conventions, testing frameworks, state management, API routing." />
      <doc path="CLAUDE.md" title="Project Rules" section="Architecture Rules" snippet="Clean Architecture: presentation → application → domain ← infrastructure. CodebaseAnalyzer will detect this and similar patterns." />
    </docs>

    <code>
      <file path="backend/src/github/domain/github-file.service.ts" kind="interface" symbol="GitHubFileService, FileTree" lines="1-142" reason="DEPENDENCY: Story 9-1 provides file reading and tree structure; CodebaseAnalyzer uses FileTree interface" />
      <file path="backend/src/tickets/domain/stack-detection/ProjectStackDetector.ts" kind="interface" symbol="ProjectStack" lines="1-180" reason="DEPENDENCY: Story 9-2 provides stack detection; CodebaseAnalyzer receives ProjectStack for context" />
      <file path="backend/src/github/infrastructure/github-file.service.ts" kind="service" symbol="GitHubFileServiceImpl" lines="1-405" reason="DEPENDENCY: Provides actual file access for pattern detection" />
      <file path="backend/src/tickets/application/services/ProjectStackDetectorImpl.ts" kind="service" symbol="ProjectStackDetectorImpl" lines="1-407" reason="DEPENDENCY: Provides framework/language/PM detection used as context" />
    </code>

    <dependencies>
      <backend>
        <package name="@nestjs/common" note="Already installed (v10.3.0); provides NestJS decorators and types" />
        <package name="zod" note="Already installed (v3.22.4); for schema validation of analysis output" />
        <package name="minimatch" note="Already installed (v9.0.3 via 9-1); for glob pattern matching on file paths" />
      </backend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="CLAUDE.md">Clean Architecture: presentation → application → domain ← infrastructure. CodebaseAnalyzer belongs in application layer as use case, with domain interfaces for patterns.</constraint>
    <constraint source="story">DEPENDENCY: Story 9-3 depends on Story 9-1 (GitHubFileService) and Story 9-2 (ProjectStackDetector). Both must be available before development.</constraint>
    <constraint source="story">Analyzer must detect: feature-based, layered, clean-architecture, hexagonal, monorepo, mvc, standard architectures with confidence scoring.</constraint>
    <constraint source="story">Naming convention detection must distinguish: files (kebab-case), variables (camelCase), functions (camelCase), classes (PascalCase), components (PascalCase).</constraint>
    <constraint source="story">Performance baseline: <500ms for full analysis on typical codebases. Implement sampling and early-exit strategies.</constraint>
    <constraint source="story">Handle edge cases: empty/minimal projects, monorepos with inconsistent patterns, legacy code, scaffolded projects, very large codebases (10k+ files), ignored directories.</constraint>
    <constraint source="story">Confidence scoring: return "recommended" (>80%), "detected" (50-80%), "uncertain" (<50%) - implement aggregate scoring across multiple signals.</constraint>
  </constraints>

  <interfaces>
    <interface name="CodebaseAnalyzer" kind="TypeScript interface" signature="analyzeStructure(files, tree): Promise<CodebaseAnalysis>" path="backend/src/tickets/application/use-cases/">
      Main interface with 7 methods: analyzeStructure(), detectArchitecture(), detectNamingConventions(), detectTestingStrategy(), detectStateManagement(), detectAPIRouting(), identifyDirectoryStructure(). Returns CodebaseAnalysis with 6 pattern categories plus recommendations.
    </interface>
    <interface name="CodebaseAnalysis" kind="Value Object" signature="{ architecture, naming, testing, stateManagement, apiRouting, directories, overallConfidence, recommendations }" path="backend/src/tickets/application/use-cases/">
      Comprehensive analysis output with all detected patterns, confidence scores, directory map, and actionable recommendations.
    </interface>
    <interface name="ArchitecturePattern" kind="Value Object" signature="{ type, confidence, signals, directories }" path="backend/src/tickets/application/use-cases/">
      Architecture detection result with confidence score and evidence signals (e.g., presence of feature directories, layer structure).
    </interface>
    <interface name="NamingConventions" kind="Value Object" signature="{ files, variables, functions, classes, components, confidence }" path="backend/src/tickets/application/use-cases/">
      Naming analysis with separate detection for each code element type.
    </interface>
    <interface name="TestingStrategy" kind="Value Object" signature="{ runner, location, namingPattern, libraries, e2eFramework, confidence }" path="backend/src/tickets/application/use-cases/">
      Testing framework detection with location patterns (colocated vs centralized) and tooling.
    </interface>
    <interface name="StateManagement" kind="Value Object" signature="{ type, packages, patterns, confidence }" path="backend/src/tickets/application/use-cases/">
      State management detection identifying framework (Zustand, Redux, Context, etc.) and usage patterns.
    </interface>
    <interface name="APIRouting" kind="Value Object" signature="{ type, baseDirectory, conventions, confidence }" path="backend/src/tickets/application/use-cases/">
      API routing detection identifying framework (Next.js App/Pages, Express, tRPC, etc.) and base directory.
    </interface>
    <interface name="FileTree" kind="Interface from 9-1" signature="{ sha, url, tree[], truncated }" path="backend/src/github/domain/github-file.service.ts">
      Structure of repository files from GitHubFileService. CodebaseAnalyzer receives this to analyze directory structure.
    </interface>
    <interface name="ProjectStack" kind="Value Object from 9-2" signature="{ framework, language, packageManager, dependencies[], ... }" path="backend/src/tickets/domain/stack-detection/ProjectStackDetector.ts">
      Stack information from ProjectStackDetector. CodebaseAnalyzer uses this as context for pattern detection.
    </interface>
  </interfaces>

  <tests>
    <standards>Backend uses Jest with NestJS testing utilities. Tests follow pattern: *.spec.ts co-located in same directory as implementation. Unit tests use fixture data for various codebase structures. Test structure: describe blocks by pattern type, arrange-act-assert pattern. 100% method coverage required per AC-9.</standards>
    <locations>
      backend/src/tickets/application/__tests__/codebase-analyzer.spec.ts
      backend/src/__tests__/integration/tickets/codebase-analysis.integration.spec.ts
    </locations>
    <ideas>
      <idea ac="AC-1">Test feature-based architecture: Create fixture with src/features/auth/, src/features/tickets/, with controllers/services/domain/infrastructure subdirs. Verify detection and >80% confidence.</idea>
      <idea ac="AC-1">Test layered architecture: Create fixture with src/presentation/, src/application/, src/domain/, src/infrastructure/. Verify detection and confidence scoring.</idea>
      <idea ac="AC-1">Test monorepo detection: Create fixture with packages/backend/, packages/frontend/, lerna.json or nx.json. Verify isMonorepo flag and pattern detection.</idea>
      <idea ac="AC-1">Test clean architecture: Create fixture with src/domain/, src/application/, src/infrastructure/ following clean arch patterns. Verify detection.</idea>
      <idea ac="AC-2">Test naming conventions: Create fixture with various file names (camelCase.ts, PascalCase.ts, snake_case.ts, kebab-case.ts). Verify dominant pattern detection and per-category analysis.</idea>
      <idea ac="AC-2">Test component naming: Create fixture with Component.tsx (PascalCase) vs index.tsx patterns. Verify component naming detection.</idea>
      <idea ac="AC-3">Test Jest detection: Create fixture with jest.config.js, __tests__/example.spec.ts, *.test.ts files. Verify runner, location, naming pattern detection.</idea>
      <idea ac="AC-3">Test Vitest detection: Create fixture with vitest.config.ts, test files with Vitest imports. Verify detection and differentiation from Jest.</idea>
      <idea ac="AC-3">Test colocated testing: Create fixture with __tests__/ directories alongside source files. Verify location: 'colocated' detection.</idea>
      <idea ac="AC-4">Test Zustand detection: Create fixture with store files using zustand import, create() hooks. Verify type detection and confidence.</idea>
      <idea ac="AC-4">Test Redux detection: Create fixture with redux, @reduxjs/toolkit packages, store/slices/ structure. Verify detection.</idea>
      <idea ac="AC-4">Test Context API detection: Create fixture with context files creating React.createContext(). No external state lib. Verify detection.</idea>
      <idea ac="AC-5">Test Next.js App Router: Create fixture with app/page.tsx, app/api/route.ts structure. Verify type: 'next-app-router' detection.</idea>
      <idea ac="AC-5">Test Next.js Pages Router: Create fixture with pages/index.tsx, pages/api/endpoint.ts. Verify type: 'next-pages-router' detection.</idea>
      <idea ac="AC-5">Test Express routing: Create fixture with routes/ directory, Express router definitions. Verify type: 'express' detection.</idea>
      <idea ac="AC-6">Test directory structure identification: Create fixture with typical directory layout (src/, components/, lib/, utils/, hooks/, types/, api/). Verify all directories identified and categorized correctly.</idea>
      <idea ac="AC-7">Test comprehensive output: Analyze this repo, verify CodebaseAnalysis has all 6 pattern categories, confidence scores, directories[], recommendations[].</idea>
      <idea ac="AC-8">Test minimal project: Create fixture with single index.ts, package.json. Verify graceful handling (uncertain scores, no patterns detected).</idea>
      <idea ac="AC-8">Test mixed patterns: Create fixture with inconsistent naming (both camelCase and snake_case), multiple testing frameworks. Verify handling and confidence reduction.</idea>
      <idea ac="AC-9">Test confidence scoring: Verify scores are 0-100, recommendations are returned, and overall confidence is sensible aggregate.</idea>
      <idea ac="AC-10">Test performance baseline: Analyze a 500+ file codebase, verify completes in <500ms with sampling strategy.</idea>
    </ideas>
  </tests>
</story-context>