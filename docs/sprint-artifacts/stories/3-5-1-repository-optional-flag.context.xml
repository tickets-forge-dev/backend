<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3.5</epicId>
    <storyId>3.5.1</storyId>
    <title>Repository Optional Flag</title>
    <status>drafted</status>
    <generatedAt>2026-02-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/3-5-1-repository-optional-flag.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Product Manager without GitHub access</asA>
    <iWant>the ability to create tickets without connecting a repository</iWant>
    <soThat>I can document requirements and assign work to developers without needing code access</soThat>
    <tasks>
      - Update backend CreateTicketDto (make repository fields optional with @IsOptional())
      - Update CreateTicketUseCase (conditional deep analysis based on repository presence)
      - Add repository checkbox UI (RepositoryToggle.tsx component with helper text and tooltip)
      - Update generation-wizard.store (add includeRepository flag and persistence)
      - Conditional rendering (hide RepositorySelector/BranchSelector when unchecked)
      - Testing (WITH repository, WITHOUT repository, validation, wizard resume, 0 TS errors)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Ticket creation UI has repository checkbox:
       - Add checkbox labeled: "Connect repository for code analysis"
       - Default: checked (maintains current behavior)
       - When unchecked: hide RepositorySelector and BranchSelector components
       - Show helper text explaining impact of choice

    2. Backend accepts optional repository:
       - CreateTicketDto fields repositoryOwner, repositoryName, branch are optional
       - CreateTicketUseCase handles both with-repo and without-repo scenarios
       - Validation: repository fields must ALL be present or ALL be absent (no partial)

    3. State management:
       - generation-wizard.store.ts tracks includeRepository: boolean flag
       - Persist flag in wizard snapshot (localStorage)
       - Resume wizard respects repository inclusion preference

    4. Skip repository-dependent phases:
       - When includeRepository = false:
         * Skip Stage 2 (Repository Context) entirely
         * Jump from Stage 1 (Input) → Stage 3 (Questions/Draft)
       - Show simplified flow indicator in wizard stepper

    5. Messaging and education:
       - Tooltip on checkbox: "Repository analysis enables AI to suggest specific files and APIs to modify. Without it, you'll get a high-level spec that developers can implement."
       - Warning banner (dismissible) when unchecked: "This ticket will not include code-aware suggestions. Developers will need to determine implementation details."

    6. 0 TypeScript errors
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/CLI/FORGE-TEAMS-CLI-ARCHITECTURE.md</path>
        <title>Forge Teams &amp; CLI Architecture</title>
        <section>Ticket Lifecycle</section>
        <snippet>Defines ticket creation flow and state machine. PM creates tickets via web UI, system supports both technical and non-technical PMs with different workflow paths.</snippet>
      </doc>
      <doc>
        <path>~/.claude/projects/-Users-Idana-Documents-GitHub-forge/memory/MEMORY.md</path>
        <title>Session 18: Repository Requirement Removal</title>
        <section>Production Fixes</section>
        <snippet>Session 18 (2026-02-10) made repository optional for PRD breakdown and bulk enrichment. Pattern: Make repository fields optional in DTOs, remove validation, handle missing repository gracefully. Backend uses undefined instead of empty strings, frontend removes RepositorySelector from flows that don't need code analysis.</snippet>
      </doc>
      <doc>
        <path>docs/CLI/SUPER-SPRINT-TEAMS-CLI-COMPLETE.md</path>
        <title>Epic 3.5: Non-Technical PM Support</title>
        <section>Story 3.5-1</section>
        <snippet>Epic goal: Support both technical and non-technical PMs with optional Git access. Repository optional + dynamic agent conversations + ticket assignment. Allows PMs to create tickets without GitHub connection.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/tickets/presentation/dto/CreateTicketDto.ts</path>
        <kind>dto</kind>
        <symbol>CreateTicketDto</symbol>
        <lines>1-53</lines>
        <reason>Current DTO with repositoryFullName and branchName as @IsOptional(). Story will verify all-or-nothing validation pattern (all present or all absent, no partial data).</reason>
      </artifact>
      <artifact>
        <path>backend/src/tickets/application/use-cases/CreateTicketUseCase.ts</path>
        <kind>use-case</kind>
        <symbol>CreateTicketUseCase</symbol>
        <lines>43-94</lines>
        <reason>Current implementation builds repositoryContext only if both repositoryFullName and branchName provided (lines 54-72). Story ensures this conditional logic works correctly when repository omitted.</reason>
      </artifact>
      <artifact>
        <path>client/src/tickets/stores/generation-wizard.store.ts</path>
        <kind>store</kind>
        <symbol>useGenerationWizardStore</symbol>
        <lines>1-100</lines>
        <reason>Zustand store managing ticket creation wizard state. Story adds includeRepository boolean flag, persists to localStorage via WizardSnapshot interface.</reason>
      </artifact>
      <artifact>
        <path>client/src/tickets/components/RepositorySelector.tsx</path>
        <kind>component</kind>
        <symbol>RepositorySelector</symbol>
        <lines>1-50</lines>
        <reason>Existing component for repository selection. Story conditionally renders this based on includeRepository flag from store.</reason>
      </artifact>
      <artifact>
        <path>backend/src/tickets/domain/aec/AEC.ts</path>
        <kind>domain</kind>
        <symbol>AEC.createDraft</symbol>
        <lines>N/A</lines>
        <reason>Domain entity accepting optional repositoryContext parameter. Story verifies AEC handles null repositoryContext correctly.</reason>
      </artifact>
    </code>
    <dependencies>
      <backend>
        <package name="@nestjs/common" version="^10.x" />
        <package name="class-validator" version="^0.x" note="Used for DTO validation decorators (@IsOptional, @IsString)" />
        <package name="@google-cloud/firestore" version="^8.x" />
      </backend>
      <frontend>
        <package name="zustand" version="^4.x" note="State management for wizard store" />
        <package name="react" version="^18.x" />
        <package name="next" version="^15.x" />
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    - **Clean Architecture**: Backend must follow presentation → application → domain separation. DTO validation in presentation layer, business logic in use case, domain entity accepts optional values.
    - **Optional Pattern from Session 18**: Follow established pattern for optional repository - use @IsOptional() decorator, check presence with conditional (if field && field), handle gracefully when absent.
    - **All-or-Nothing Validation**: Repository fields must ALL be present or ALL be absent. No partial data (e.g., owner without branch).
    - **Backward Compatibility**: Default checkbox to checked (includeRepository = true) to maintain current behavior for existing users.
    - **State Persistence**: Wizard state persists to localStorage with 24-hour TTL. Must include includeRepository flag in WizardSnapshot interface.
    - **0 TypeScript Errors**: Required for all stories. Use strict typing, avoid any casts, ensure full type safety.
  </constraints>

  <interfaces>
    <interface>
      <name>CreateTicketCommand</name>
      <kind>use-case-input</kind>
      <signature>
        interface CreateTicketCommand {
          workspaceId: string;
          userId: string;
          userEmail: string;
          title: string;
          description?: string;
          repositoryFullName?: string;  // Optional - story maintains this
          branchName?: string;           // Optional - story maintains this
          maxRounds?: number;
          type?: 'feature' | 'bug' | 'task';
          priority?: 'low' | 'medium' | 'high' | 'urgent';
          taskAnalysis?: any;
        }
      </signature>
      <path>backend/src/tickets/application/use-cases/CreateTicketUseCase.ts</path>
    </interface>
    <interface>
      <name>CreateTicketDto</name>
      <kind>dto</kind>
      <signature>
        export class CreateTicketDto {
          @IsString() @MinLength(3) @MaxLength(500) title!: string;
          @IsString() @IsOptional() description?: string;
          @IsString() @IsOptional() @Matches(...) repositoryFullName?: string;
          @IsString() @IsOptional() @Matches(...) branchName?: string;
          @IsOptional() @IsInt() @Min(0) @Max(3) maxRounds?: number;
          @IsIn(['feature', 'bug', 'task']) @IsOptional() type?: ...;
          @IsIn(['low', 'medium', 'high', 'urgent']) @IsOptional() priority?: ...;
        }
      </signature>
      <path>backend/src/tickets/presentation/dto/CreateTicketDto.ts</path>
    </interface>
    <interface>
      <name>WizardSnapshot</name>
      <kind>local-storage-schema</kind>
      <signature>
        interface WizardSnapshot {
          currentStage: number;
          input: WizardState['input'];
          type: string;
          priority: string;
          draftAecId: string | null;
          maxRounds: number;
          context: WizardState['context'];
          timestamp: number;
          // Story adds: includeRepository: boolean;
        }
      </signature>
      <path>client/src/tickets/stores/generation-wizard.store.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Backend uses Jest for unit testing with describe/it blocks. Use cases have .spec.ts files testing command execution, validation, and domain interaction. Frontend would use React Testing Library for component tests. Test both positive (valid data) and negative (invalid/partial data) cases. Verify validation errors match expectations.
    </standards>
    <locations>
      - backend/src/**/*.spec.ts (unit tests for use cases, domain, services)
      - backend/src/**/dto/__tests__/*.spec.ts (DTO validation tests)
      - client/src/**/*.test.tsx (component tests)
    </locations>
    <ideas>
      - AC#2 Backend: Test CreateTicketDto with all repository fields present (valid), all absent (valid), partial fields (invalid - should fail validation)
      - AC#2 Backend: Test CreateTicketUseCase.execute() with repositoryFullName+branchName (should build repositoryContext), without them (should skip context building)
      - AC#3 Frontend: Test generation-wizard.store setIncludeRepository() updates state correctly
      - AC#3 Frontend: Test WizardSnapshot saveSnapshot/loadSnapshot persists includeRepository flag
      - AC#1,#4 Frontend: Test RepositoryToggle component toggles checkbox, shows/hides RepositorySelector
      - AC#6: Run tsc --noEmit in CI to verify 0 TypeScript errors
    </ideas>
  </tests>
</story-context>
