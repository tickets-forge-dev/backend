<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.6</storyId>
    <title>Team Service (Frontend)</title>
    <status>drafted</status>
    <generatedAt>2026-02-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/1-6-team-service-frontend.md</sourceStoryPath>
    <note>⚠️ IMPLEMENTATION ALREADY EXISTS - Story appears to be complete. Context generated for reference and review.</note>
  </metadata>

  <story>
    <asA>frontend developer</asA>
    <iWant>a team service that wraps all team API calls</iWant>
    <soThat>UI components have a clean abstraction for team operations</soThat>
    <tasks>
      <task id="1" goal="Create TeamService class (AC: 1-6)" status="APPEARS COMPLETE">
        <subtask>Define TeamService interface with all CRUD methods</subtask>
        <subtask>Implement createTeam() - POST request with validation</subtask>
        <subtask>Implement getTeams() - GET request with auth token</subtask>
        <subtask>Implement getTeam(teamId) - GET by ID with error handling</subtask>
        <subtask>Implement updateTeam(teamId, updates) - PATCH with ownership check</subtask>
        <subtask>Implement deleteTeam(teamId) - DELETE with confirmation</subtask>
        <subtask>Implement switchTeam(teamId) - POST /teams/switch</subtask>
      </task>
      <task id="2" goal="Add TypeScript types (AC: 7)" status="APPEARS COMPLETE">
        <subtask>Create types: Team, TeamSummary, CreateTeamRequest, UpdateTeamRequest, SwitchTeamRequest</subtask>
        <subtask>Ensure all service methods return typed responses</subtask>
        <subtask>Export types for use in components</subtask>
      </task>
      <task id="3" goal="Error handling (AC: 8)" status="APPEARS COMPLETE">
        <subtask>Wrap API calls in try-catch blocks</subtask>
        <subtask>Map backend errors to user-friendly messages</subtask>
        <subtask>Handle 400 (validation), 403 (forbidden), 404 (not found) cases</subtask>
        <subtask>Return consistent error format</subtask>
      </task>
      <task id="4" goal="Service registration (AC: 9)" status="NEEDS VERIFICATION">
        <subtask>Register TeamService in core/services/index.ts (VERIFY IF DONE)</subtask>
        <subtask>Ensure singleton pattern via useServices() hook (VERIFY)</subtask>
        <subtask>Add JSDoc comments for IDE autocomplete (VERIFY)</subtask>
      </task>
      <task id="5" goal="Build verification (AC: 10)" status="NEEDS VERIFICATION">
        <subtask>Run npm run build in client directory</subtask>
        <subtask>Fix any TypeScript errors</subtask>
        <subtask>Verify no new ESLint warnings</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1" status="IMPLEMENTED">TeamService class implements all team API calls</criterion>
    <criterion id="2" status="IMPLEMENTED">createTeam(name: string) - POST /teams</criterion>
    <criterion id="3" status="IMPLEMENTED">getTeams() - GET /teams (user's teams) - Method name: getUserTeams()</criterion>
    <criterion id="4" status="IMPLEMENTED">getTeam(teamId: string) - GET /teams/:id</criterion>
    <criterion id="5" status="IMPLEMENTED">updateTeam(teamId, updates) - PATCH /teams/:id</criterion>
    <criterion id="6" status="IMPLEMENTED">deleteTeam(teamId) - DELETE /teams/:id</criterion>
    <criterion id="7" status="IMPLEMENTED">All methods return typed responses (Team, TeamSummary)</criterion>
    <criterion id="8" status="IMPLEMENTED">Error handling with user-friendly messages</criterion>
    <criterion id="9" status="NEEDS_VERIFICATION">Service integrated with useServices() hook</criterion>
    <criterion id="10" status="NEEDS_VERIFICATION">TypeScript errors = 0</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/IMPLEMENTATION-PLAN.md</path>
        <title>Forge Teams + CLI + MCP - Implementation Plan</title>
        <section>EPIC 1: Team Foundation (P0) - 2.5 weeks</section>
        <snippet>Story 1.6: Team Service (Frontend) (1d) - API client service for frontend to call team endpoints. Provides clean abstraction for UI components.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/1-5-team-api-endpoints.md</path>
        <title>Story 1.5: Team API Endpoints (Backend)</title>
        <section>API Endpoints</section>
        <snippet>POST /teams (create), GET /teams (list), GET /teams/:id (get by ID), PATCH /teams/:id (update), DELETE /teams/:id (soft delete). All require Firebase Bearer token.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>client/src/teams/services/team.service.ts</path>
        <kind>service</kind>
        <symbol>TeamService</symbol>
        <lines>1-208</lines>
        <reason>⚠️ EXISTING IMPLEMENTATION - Full TeamService with all CRUD operations, Firebase auth, error handling, and types already implemented</reason>
        <status>COMPLETE - Review for quality and integration verification</status>
      </file>
      <file>
        <path>client/src/services/auth.service.ts</path>
        <kind>service</kind>
        <symbol>AuthService</symbol>
        <lines>1-51</lines>
        <reason>Reference pattern for service structure, Firebase auth token retrieval, and API URL configuration</reason>
      </file>
      <file>
        <path>client/src/services/ticket.service.ts</path>
        <kind>service</kind>
        <symbol>TicketService</symbol>
        <reason>Reference pattern for frontend service implementation with fetch() and error handling</reason>
      </file>
    </code>
    <dependencies>
      <framework name="Next.js" ecosystem="node" />
      <framework name="React" ecosystem="node" />
      <framework name="Firebase Auth" ecosystem="node" version="^10.x" />
      <package name="firebase" ecosystem="node" usage="Authentication and auth token retrieval" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Follow service layer pattern - singleton registration, fetch() for HTTP, typed responses</constraint>
    <constraint type="authentication">All API calls require Firebase Bearer token via Authorization header</constraint>
    <constraint type="error_handling">Use consistent error format: throw Error with message from backend or fallback message</constraint>
    <constraint type="environment">Base URL from process.env.NEXT_PUBLIC_API_URL - MUST be set or service throws error</constraint>
    <constraint type="naming">Class: PascalCase (TeamService), File: kebab-case (team.service.ts), Methods: camelCase</constraint>
    <constraint type="types">Use TypeScript strict mode - all methods must have typed parameters and return types</constraint>
    <constraint type="singleton">Export singleton instance: `export const teamService = new TeamService()`</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /teams</name>
      <kind>REST endpoint</kind>
      <signature>POST /teams { name: string, allowMemberInvites?: boolean } → { team: Team }</signature>
      <path>backend/src/teams/presentation/controllers/teams.controller.ts</path>
      <note>Creates new team, returns team object with id, slug, settings</note>
    </interface>
    <interface>
      <name>GET /teams</name>
      <kind>REST endpoint</kind>
      <signature>GET /teams → { teams: TeamSummary[], currentTeamId: string | null }</signature>
      <path>backend/src/teams/presentation/controllers/teams.controller.ts</path>
      <note>Returns user's teams with isCurrent flag</note>
    </interface>
    <interface>
      <name>GET /teams/:id</name>
      <kind>REST endpoint</kind>
      <signature>GET /teams/:id → { team: Team }</signature>
      <path>backend/src/teams/presentation/controllers/teams.controller.ts</path>
      <note>Returns single team by ID with full details</note>
    </interface>
    <interface>
      <name>PATCH /teams/:id</name>
      <kind>REST endpoint</kind>
      <signature>PATCH /teams/:id { name?: string, settings?: {...} } → { team: Team }</signature>
      <path>backend/src/teams/presentation/controllers/teams.controller.ts</path>
      <note>Updates team (requires owner), returns updated team</note>
    </interface>
    <interface>
      <name>POST /teams/switch</name>
      <kind>REST endpoint</kind>
      <signature>POST /teams/switch { teamId: string } → { currentTeam: { currentTeamId, teamName } }</signature>
      <path>backend/src/teams/presentation/controllers/teams.controller.ts</path>
      <note>Switches user's current team</note>
    </interface>
    <interface>
      <name>DELETE /teams/:id</name>
      <kind>REST endpoint</kind>
      <signature>DELETE /teams/:id → void (204 No Content)</signature>
      <path>backend/src/teams/presentation/controllers/teams.controller.ts</path>
      <note>Soft deletes team (requires owner)</note>
    </interface>
    <interface>
      <name>TeamService</name>
      <kind>class interface</kind>
      <signature>
        class TeamService {
          createTeam(request: CreateTeamRequest): Promise&lt;Team&gt;
          getUserTeams(): Promise&lt;{ teams: TeamSummary[]; currentTeamId: string | null }&gt;
          getTeam(teamId: string): Promise&lt;Team&gt;
          updateTeam(teamId: string, request: UpdateTeamRequest): Promise&lt;Team&gt;
          switchTeam(request: SwitchTeamRequest): Promise&lt;{ currentTeamId: string; teamName: string }&gt;
          deleteTeam(teamId: string): Promise&lt;void&gt;
        }
      </signature>
      <path>client/src/teams/services/team.service.ts</path>
      <note>⚠️ ALREADY IMPLEMENTED - See file for complete implementation</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual testing required for service integration:
      1. Verify service can create team → Check response includes teamId
      2. Verify getUserTeams() → Check user's teams returned with isCurrent flags
      3. Verify getTeam(id) → Check correct team returned
      4. Verify updateTeam() → Check changes persisted
      5. Verify switchTeam() → Check currentTeamId updated
      6. Verify deleteTeam() → Check team no longer in list
      7. Test error handling → Verify user-friendly error messages for 400/403/404

      Integration tests (Phase 2 - Epic 8):
      - Use MSW (Mock Service Worker) to mock API responses
      - Test all CRUD operation success paths
      - Test error handling for 400/403/404/500 responses
      - Verify auth token is included in all requests
    </standards>
    <locations>
      client/src/__tests__/ (future integration tests)
      client/src/teams/__tests__/ (future unit tests)
    </locations>
    <ideas>
      <idea ac="1,2,3,4,5,6">Test all CRUD operations - create, getUserTeams, getTeam, updateTeam, switchTeam, deleteTeam</idea>
      <idea ac="7">Verify all methods return correctly typed responses (Team, TeamSummary)</idea>
      <idea ac="8">Test error handling - mock 400, 403, 404 responses and verify error messages</idea>
      <idea ac="9">Verify service is registered and accessible via useServices() hook</idea>
      <idea ac="10">Run TypeScript compiler and verify zero errors</idea>
    </ideas>
  </tests>

  <implementation_status>
    <summary>⚠️ STORY APPEARS TO BE ALREADY IMPLEMENTED</summary>
    <details>
      The file `client/src/teams/services/team.service.ts` exists with a complete implementation:
      - All 6 CRUD methods implemented (createTeam, getUserTeams, getTeam, updateTeam, switchTeam, deleteTeam)
      - TypeScript types defined (Team, TeamSummary, CreateTeamRequest, UpdateTeamRequest, SwitchTeamRequest)
      - Firebase auth integration with getAuthToken() helper
      - Error handling for all API calls
      - Singleton pattern with exported instance

      REMAINING WORK:
      1. Verify service is registered in core/services/index.ts for useServices() hook
      2. Run build to verify zero TypeScript errors
      3. Add JSDoc comments if missing
      4. Consider adding unit tests (Phase 2 - Epic 8)
      5. Update story status from "drafted" to "done" if all ACs verified
    </details>
    <recommendation>
      Run verification workflow to check:
      - Service registration in core/services/index.ts
      - TypeScript build passes (npm run build)
      - All acceptance criteria met
      If all verified → Mark story as DONE and move to Story 1.7 (Team Store)
    </recommendation>
  </implementation_status>
</story-context>
